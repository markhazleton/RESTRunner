@model RESTRunner.Web.Models.TestConfiguration
@{
    ViewData["Title"] = "Configuration Details";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Configuration Details</h1>
        <div>
            <a href="/Configuration/Edit/@Model.Id" class="btn btn-primary">
                Edit
            </a>
            <a href="/Configuration" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    <div class="row">
        <!-- Basic Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Configuration Name</h6>
                            <p>@Model.Name</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Status</h6>
                            <p>
                                @if (Model.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p>@Model.Description</p>
                        </div>
                    }

                    @if (Model.Tags.Any())
                    {
                        <div class="mb-3">
                            <h6>Tags</h6>
                            <p>
                                @foreach (var tag in Model.Tags)
                                {
                                    <span class="badge bg-light text-dark me-1">@tag</span>
                                }
                            </p>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-4">
                            <h6>Iterations</h6>
                            <p>@Model.Iterations</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Max Concurrency</h6>
                            <p>@Model.MaxConcurrency</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Total Test Count</h6>
                            <p><strong>@Model.GetTotalTestCount()</strong> combinations</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Test Configuration</h5>
                </div>
                <div class="card-body">
                    <!-- Instances -->
                    <div class="mb-4">
                        <h6>Test Instances (@Model.Runner.Instances.Count)</h6>
                        @if (Model.Runner.Instances.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Base URL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var instance in Model.Runner.Instances)
                                        {
                                            <tr>
                                                <td><code>@instance.Name</code></td>
                                                <td><a href="@instance.BaseUrl" target="_blank">@instance.BaseUrl</a></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No instances configured</p>
                        }
                    </div>

                    <!-- Users -->
                    <div class="mb-4">
                        <h6>Test Users (@Model.Runner.Users.Count)</h6>
                        @if (Model.Runner.Users.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Properties</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var user in Model.Runner.Users)
                                        {
                                            <tr>
                                                <td><code>@user.UserName</code></td>
                                                <td>
                                                    @if (user.Properties.Any())
                                                    {
                                                        @foreach (var prop in user.Properties.Take(3))
                                                        {
                                                            <small class="badge bg-light text-dark me-1">@prop.Key</small>
                                                        }
                                                        @if (user.Properties.Count > 3)
                                                        {
                                                            <small class="text-muted">+@(user.Properties.Count - 3) more</small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No properties</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No users configured</p>
                        }
                    </div>

                    <!-- Requests -->
                    <div class="mb-4">
                        <h6>Test Requests (@Model.Runner.Requests.Count)</h6>
                        @if (Model.Runner.Requests.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Method</th>
                                            <th>Path</th>
                                            <th>Auth Required</th>
                                            <th>Body Template</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var request in Model.Runner.Requests)
                                        {
                                            <tr>
                                                <td>
                                                    <span class="badge bg-@(request.RequestMethod.ToString() switch 
                                                    {
                                                        "GET" => "success",
                                                        "POST" => "primary", 
                                                        "PUT" => "warning",
                                                        "DELETE" => "danger",
                                                        _ => "secondary"
                                                    })">
                                                        @request.RequestMethod
                                                    </span>
                                                </td>
                                                <td><code>@request.Path</code></td>
                                                <td>
                                                    @if (request.RequiresClientToken)
                                                    {
                                                        <span class="text-success">[YES]</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">[NO]</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(request.BodyTemplate))
                                                    {
                                                        <small class="text-muted">Has body template</small>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No requests configured</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="runConfiguration">
                            Run Configuration
                        </button>
                        <a href="/Configuration/Edit/@Model.Id" class="btn btn-primary">
                            Edit Configuration
                        </a>
                        <a href="/Configuration/Export/@Model.Id" class="btn btn-info">
                            Export JSON
                        </a>
                        <button type="button" class="btn btn-outline-warning" id="duplicateConfig">
                            Duplicate
                        </button>
                        <a href="/Configuration/Delete/@Model.Id" class="btn btn-outline-danger">
                            Delete
                        </a>
                    </div>
                </div>
            </div>

            <!-- Metadata -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Metadata</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Created</small>
                        <div>@Model.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Last Modified</small>
                        <div>@Model.ModifiedAt.ToString("MMM dd, yyyy 'at' HH:mm")</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Created By</small>
                        <div>@Model.CreatedBy</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Configuration ID</small>
                        <div><code class="small">@Model.Id</code></div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Test Breakdown</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 text-primary">@Model.Runner.Instances.Count</div>
                            <small class="text-muted">Instances</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-success">@Model.Runner.Requests.Count</div>
                            <small class="text-muted">Requests</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-info">@Model.Runner.Users.Count</div>
                            <small class="text-muted">Users</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <div class="h3 text-warning">@Model.GetTotalTestCount()</div>
                        <small class="text-muted">Total test combinations<br>(@Model.Iterations iterations)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        let connection = null;
        let currentExecutionId = null;

        // Initialize SignalR connection
        async function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/execution")
                .withAutomaticReconnect()
                .build();

            connection.on("ProgressUpdate", function (execution) {
                updateProgressUI(execution);
            });

            connection.on("ExecutionCompleted", function (history) {
                showCompletionMessage(history);
                setTimeout(() => {
                    window.location.href = `/Execution/Results/${history.id}`;
                }, 2000);
            });

            connection.on("ExecutionFailed", function (data) {
                showErrorMessage(data.errorMessage);
            });

            connection.on("ExecutionCancelled", function (data) {
                showWarningMessage("Execution was cancelled");
            });

            try {
                await connection.start();
                console.log("SignalR connected");
            } catch (err) {
                console.error("SignalR connection error:", err);
            }
        }

        // Run configuration
        document.getElementById('runConfiguration').addEventListener('click', async function() {
            const configId = '@Model.Id';
            
            try {
                // Start execution
                const response = await fetch('/api/execution/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        configurationId: configId,
                        executedBy: 'Web User'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showErrorMessage(error.detail || 'Failed to start execution');
                    return;
                }

                const execution = await response.json();
                currentExecutionId = execution.id;

                // Join execution group in SignalR
                if (connection) {
                    await connection.invoke("JoinExecution", currentExecutionId);
                }

                // Show progress modal
                showProgressModal(execution);

            } catch (error) {
                console.error('Error starting execution:', error);
                showErrorMessage('Failed to start execution: ' + error.message);
            }
        });

        // Duplicate configuration
        document.getElementById('duplicateConfig').addEventListener('click', function() {
            if (confirm('Create a copy of this configuration?')) {
                // In a real implementation, this would duplicate the config
                alert('Duplicate feature coming soon! This will create a copy with a new name.');
            }
        });

        function showProgressModal(execution) {
            const modalHtml = `
                <div class="modal fade" id="executionProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Execution in Progress</h5>
                            </div>
                            <div class="modal-body">
                                <h6 id="currentPhase">${execution.currentPhase}</h6>
                                <div class="progress mb-3" style="height: 30px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="h4" id="completedRequests">0</div>
                                        <small class="text-muted">Completed</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-success" id="successfulRequests">0</div>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-danger" id="failedRequests">0</div>
                                        <small class="text-muted">Failed</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4" id="avgResponseTime">0</div>
                                        <small class="text-muted">Avg (ms)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" onclick="cancelExecution()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('executionProgressModal'));
            modal.show();
        }

        function updateProgressUI(execution) {
            document.getElementById('currentPhase').textContent = execution.currentPhase;
            document.getElementById('progressBar').style.width = execution.progressPercentage + '%';
            document.getElementById('progressBar').textContent = Math.round(execution.progressPercentage) + '%';
            document.getElementById('completedRequests').textContent = execution.completedRequests;
            document.getElementById('successfulRequests').textContent = execution.successfulRequests;
            document.getElementById('failedRequests').textContent = execution.failedRequests;
            document.getElementById('avgResponseTime').textContent = Math.round(execution.currentAverageResponseTime);
        }

        async function cancelExecution() {
            if (!currentExecutionId) return;

            try {
                const response = await fetch(`/api/execution/${currentExecutionId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cancelledBy: 'Web User'
                    })
                });

                if (response.ok) {
                    showWarningMessage('Execution cancelled');
                }
            } catch (error) {
                console.error('Error cancelling execution:', error);
            }
        }

        function showCompletionMessage(history) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('executionProgressModal'));
            if (modal) modal.hide();
            
            showSuccessMessage(`Execution completed! ${history.statistics.successfulRequests} successful, ${history.statistics.failedRequests} failed`);
        }

        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'danger');
        }

        function showWarningMessage(message) {
            showToast(message, 'warning');
        }

        function showToast(message, type) {
            const toastHtml = `
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                    <div class="toast show bg-${type} text-white" role="alert">
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(() => {
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(t => t.remove());
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignalR();
        });
    </script>
}